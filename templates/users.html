{% extends "base.html" %}
{% block title %}User Management - Petition Tracker{% endblock %}
{% block page_title %}User Management{% endblock %}

{% block content %}
<div class="users-page">
    <div class="card">
        <div class="card-header">
            <h2>Create Officer Login</h2>
        </div>
        <form method="POST" action="{{ url_for('user_create') }}" class="user-form">
            <div class="form-grid">
                <div class="form-group">
                    <label>Username <span class="required">*</span></label>
                    <input type="text" name="username" required placeholder="Login username">
                </div>
                <div class="form-group">
                    <label>Password <span class="required">*</span></label>
                    <input type="password" name="password" required placeholder="Set password">
                </div>
                <div class="form-group">
                    <label>Officer Name <span class="required">*</span></label>
                    <input type="text" name="full_name" required placeholder="Officer full name">
                </div>
                <div class="form-group">
                    <label>Role <span class="required">*</span></label>
                    <select name="role" required id="newUserRole" onchange="toggleCVOFields(this)">
                        <option value="">-- Select Role --</option>
                        <option value="data_entry">Data Entry Operator</option>
                        <option value="po">Personal Officer (Vigilance)</option>
                        <option value="cmd_apspdcl">CMD - APSPDCL</option>
                        <option value="cmd_apepdcl">CMD - APEPDCL</option>
                        <option value="cmd_apcpdcl">CMD - APCPDCL</option>
                        <option value="cgm_hr_transco">CGM/HR TRANSCO (Headquarters)</option>
                        <option value="dsp">DSP (Headquarters)</option>
                        <option value="cvo_apspdcl">CVO - APSPDCL (Tirupathi)</option>
                        <option value="cvo_apepdcl">CVO - APEPDCL (Vizag)</option>
                        <option value="cvo_apcpdcl">CVO - APCPDCL (Vijayawada)</option>
                        <option value="inspector">Field Inspector (CI/SI)</option>
                    </select>
                </div>
                <div class="form-group cvo-field" id="cvoOfficeGroup" style="display:none;">
                    <label>Office</label>
                    <select name="cvo_office">
                        <option value="">-- Not Applicable --</option>
                        <option value="apspdcl">APSPDCL</option>
                        <option value="apepdcl">APEPDCL</option>
                        <option value="apcpdcl">APCPDCL</option>
                        <option value="headquarters">Headquarters</option>
                    </select>
                </div>
                <div class="form-group cvo-field" id="assignedCVOGroup" style="display:none;">
                    <label>Assigned to CVO/DSP</label>
                    <select name="assigned_cvo_id">
                        <option value="">-- Select CVO/DSP --</option>
                        {% for cvo in cvo_users %}
                        <option value="{{ cvo.id }}">{{ cvo.full_name }} ({{ role_labels.get(cvo.role, cvo.role) }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="text" name="phone" placeholder="Phone number">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="email" placeholder="Email address">
                </div>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Create User</button>
            </div>
        </form>
    </div>

    <div class="card">
        <div class="card-header">
            <h2>Bulk Create Users (Excel/CSV)</h2>
        </div>
        <form method="POST" action="{{ url_for('users_upload') }}" enctype="multipart/form-data" class="user-form">
            <div style="padding: 0 1.5rem 1rem 1.5rem; color: #6b7280; font-size: 0.9rem;">
                Required columns: <code>username</code>, <code>password</code>, <code>full_name</code>, <code>role</code><br>
                Optional: <code>cvo_office</code>, <code>assigned_cvo_username</code>, <code>phone</code>, <code>email</code>
            </div>
            <div class="form-grid">
                <div class="form-group full-width">
                    <label>Upload File (.xlsx or .csv) <span class="required">*</span></label>
                    <input type="file" name="users_file" accept=".xlsx,.csv" required>
                </div>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Upload & Create Users</button>
            </div>
        </form>
    </div>

    <div class="card">
        <div class="card-header user-admin-header">
            <h2>Officer Directory & Controls</h2>
            <div class="header-actions user-admin-tools">
                <div class="filter-group">
                    <label>Select User</label>
                    <select id="userPicker" class="filter-select" onchange="applyUserSelection()">
                        <option value="">-- Choose user to manage --</option>
                        {% for u in users %}
                        <option value="{{ u.id }}">{{ u.full_name }} (@{{ u.username }}) - {{ role_labels.get(u.role, u.role) }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        <div class="user-admin-hint">
            Select one user from the dropdown to edit details, credentials, mapping, and status.
        </div>
        <div id="userSelectPrompt" class="user-admin-hint">No user selected yet.</div>
        <div id="userControlGrid" class="user-admin-grid">
            {% for u in users %}
            <article
                class="user-admin-card {% if not u.is_active %}user-admin-card-inactive{% endif %}"
                data-user-id="{{ u.id }}"
                data-role="{{ u.role }}"
                data-status="{% if u.is_active %}active{% else %}inactive{% endif %}"
                data-search="{{ (u.username ~ ' ' ~ u.full_name ~ ' ' ~ role_labels.get(u.role, u.role)) | lower }}"
            >
                <div class="user-admin-card-head">
                    <div class="user-admin-identity">
                        {% if u.profile_photo %}
                        <img src="{{ url_for('profile_photo_file', filename=u.profile_photo) }}" alt="Profile" class="table-avatar">
                        {% else %}
                        <div class="table-avatar table-avatar-fallback">{{ u.full_name[0] if u.full_name else 'U' }}</div>
                        {% endif %}
                        <div>
                            <div class="user-admin-name">{{ u.full_name }}</div>
                            <div class="user-admin-username">@{{ u.username }}</div>
                        </div>
                    </div>
                    <div class="user-admin-badges">
                        <span class="badge badge-role">{{ role_labels.get(u.role, u.role) }}</span>
                        {% if u.is_active %}
                        <span class="badge user-badge-active">Active</span>
                        {% else %}
                        <span class="badge user-badge-inactive">Inactive</span>
                        {% endif %}
                    </div>
                </div>

                <div class="user-admin-meta">
                    <div><span class="user-admin-meta-label">Phone:</span> {{ u.phone or '-' }}</div>
                    <div><span class="user-admin-meta-label">Email:</span> {{ u.email or '-' }}</div>
                </div>

                <details class="user-admin-actions">
                    <summary>Manage User</summary>

                    <div class="user-action-grid">
                        <form method="POST" action="{{ url_for('user_update_name', user_id=u.id) }}" class="user-action-card">
                            <h4>Update Name</h4>
                            <input type="text" name="full_name" required minlength="3" value="{{ u.full_name }}">
                            <button type="submit" class="btn btn-xs btn-primary">Save Name</button>
                        </form>

                        <form method="POST" action="{{ url_for('user_reset_username', user_id=u.id) }}" class="user-action-card">
                            <h4>Reset Username</h4>
                            <input type="text" name="new_username" required minlength="3" placeholder="New username">
                            <button type="submit" class="btn btn-xs btn-primary">Reset Username</button>
                        </form>

                        <form method="POST" action="{{ url_for('user_reset_password', user_id=u.id) }}" class="user-action-card">
                            <h4>Reset Password</h4>
                            <input type="password" name="new_password" required minlength="6" placeholder="New password">
                            <button type="submit" class="btn btn-xs btn-primary">Reset Password</button>
                        </form>

                        <form method="POST" action="{{ url_for('user_update_contact', user_id=u.id) }}" enctype="multipart/form-data" class="user-action-card">
                            <h4>Contact & Photo</h4>
                            <input type="text" name="phone" placeholder="Phone" value="{{ u.phone or '' }}">
                            <input type="email" name="email" placeholder="Email" value="{{ u.email or '' }}">
                            <input type="file" name="profile_photo" accept=".jpg,.jpeg,.png,.webp">
                            {% if u.profile_photo %}
                            <label class="user-action-check">
                                <input type="checkbox" name="remove_photo"> Remove current photo
                            </label>
                            {% endif %}
                            <button type="submit" class="btn btn-xs btn-primary">Save Contact/Photo</button>
                        </form>

                        {% if u.role == 'inspector' %}
                        {% set map = (inspector_mappings | selectattr('id', 'equalto', u.id) | list | first) %}
                        <form method="POST" action="{{ url_for('user_map_cvo', inspector_id=u.id) }}" class="user-action-card">
                            <h4>Map Inspector</h4>
                            <select name="cvo_id" required>
                                <option value="">-- Select CVO/DSP --</option>
                                {% for cvo in cvo_users %}
                                <option value="{{ cvo.id }}" {% if map and map.mapped_cvo_id == cvo.id %}selected{% endif %}>
                                    {{ cvo.full_name }} ({{ role_labels.get(cvo.role, cvo.role) }})
                                </option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn btn-xs btn-primary">Save Mapping</button>
                        </form>
                        {% endif %}

                        <form method="POST" action="{{ url_for('user_toggle', user_id=u.id) }}" class="user-action-card">
                            <h4>Activation</h4>
                            <p class="user-action-note">Current status: {{ 'Active' if u.is_active else 'Inactive' }}</p>
                            <button type="submit" class="btn btn-xs {% if u.is_active %}btn-danger{% else %}btn-success{% endif %}">
                                {{ 'Deactivate User' if u.is_active else 'Activate User' }}
                            </button>
                        </form>
                    </div>
                </details>
            </article>
            {% endfor %}
        </div>
    </div>
</div>

<script>
function toggleCVOFields(select) {
    const role = select.value;
    const cvoOffice = document.getElementById('cvoOfficeGroup');
    const assignedCVO = document.getElementById('assignedCVOGroup');

    if (role === 'inspector') {
        cvoOffice.style.display = 'block';
        assignedCVO.style.display = 'block';
    } else if (role.startsWith('cvo_') || role === 'dsp') {
        cvoOffice.style.display = 'block';
        assignedCVO.style.display = 'none';
    } else {
        cvoOffice.style.display = 'none';
        assignedCVO.style.display = 'none';
    }
}

function applyUserSelection() {
    const picker = document.getElementById('userPicker');
    const selectedUser = (picker && picker.value) ? picker.value : '';
    const prompt = document.getElementById('userSelectPrompt');
    const cards = document.querySelectorAll('#userControlGrid .user-admin-card');
    cards.forEach(card => {
        card.style.display = selectedUser && card.dataset.userId === selectedUser ? '' : 'none';
    });
    if (prompt) {
        prompt.style.display = selectedUser ? 'none' : '';
    }
}

document.addEventListener('DOMContentLoaded', function () {
    applyUserSelection();
});
</script>
{% endblock %}

