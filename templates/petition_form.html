{% extends "base.html" %}
{% block title %}New Petition - Petition Tracker{% endblock %}
{% block page_title %}<span data-i18n="petition.new.page_title">New Petition Entry</span>{% endblock %}

{% block content %}
{% set f_received_date = get_field_cfg('deo_petition', 'received_date') %}
{% set f_received_at = get_field_cfg('deo_petition', 'received_at') %}
{% set f_ereceipt_no = get_field_cfg('deo_petition', 'ereceipt_no') %}
{% set f_ereceipt_file = get_field_cfg('deo_petition', 'ereceipt_file') %}
{% set f_target_cvo = get_field_cfg('deo_petition', 'target_cvo') %}
{% set f_permission_request = get_field_cfg('deo_petition', 'permission_request_type') %}
{% set f_petitioner_name = get_field_cfg('deo_petition', 'petitioner_name') %}
{% set f_contact = get_field_cfg('deo_petition', 'contact') %}
{% set f_place = get_field_cfg('deo_petition', 'place') %}
{% set f_subject = get_field_cfg('deo_petition', 'subject') %}
{% set f_petition_type = get_field_cfg('deo_petition', 'petition_type') %}
{% set f_source = get_field_cfg('deo_petition', 'source_of_petition') %}
{% set f_remarks = get_field_cfg('deo_petition', 'remarks') %}
{% set f_govt_inst = get_field_cfg('deo_petition', 'govt_institution_type') %}
{% set deo_locked = current_user_role == 'data_entry' and deo_flow %}
{% set deo_target_options = deo_target_options or [] %}
<div class="card">
    <div class="card-header">
        <h2 data-i18n="petition.new.form_title">Petition Entry Form</h2>
    </div>
    <form method="POST" action="{{ url_for('petition_new') }}" class="petition-form" enctype="multipart/form-data">
        <div class="form-grid">
            <div class="form-group">
                <label for="received_date"><span data-i18n="petition.form.received_date">{{ f_received_date.label }}</span> {% if f_received_date.required %}<span class="required">*</span>{% endif %}</label>
                {% if f_received_date.type == 'textarea' %}
                <textarea id="received_date" name="received_date" rows="1" {% if f_received_date.required %}required{% endif %}>{{ request.form.get('received_date') or now.strftime('%Y-%m-%d') }}</textarea>
                {% else %}
                <input type="{{ f_received_date.type }}" id="received_date" name="received_date" value="{{ request.form.get('received_date') or now.strftime('%Y-%m-%d') }}" {% if f_received_date.required %}required{% endif %}>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="received_at"><span data-i18n="petition.form.received_at">{{ f_received_at.label }}</span> {% if f_received_at.required %}<span class="required">*</span>{% endif %}</label>
                <select id="received_at" name="received_at" {% if f_received_at.required %}required{% endif %}>
                    <option value="" data-i18n="petition.form.select_office">-- Select Office --</option>
                    {% if deo_locked %}
                    {% for opt in deo_target_options %}
                    <option value="{{ opt.received_at }}" {% if (request.form.get('target_cvo') and request.form.get('target_cvo') == opt.target_cvo) or (not request.form.get('target_cvo') and loop.first) %}selected{% endif %}>{{ opt.received_at_label }}</option>
                    {% endfor %}
                    {% else %}
                    <option value="jmd_office" data-i18n="petition.form.office.jmd" {% if request.form.get('received_at') == 'jmd_office' %}selected{% endif %}>JMD Office</option>
                    <option value="cvo_apspdcl_tirupathi" data-i18n="petition.form.office.apspdcl" {% if request.form.get('received_at') == 'cvo_apspdcl_tirupathi' %}selected{% endif %}>CVO/DSP (APSPDCL) - Tirupathi</option>
                    <option value="cvo_apepdcl_vizag" data-i18n="petition.form.office.apepdcl" {% if request.form.get('received_at') == 'cvo_apepdcl_vizag' %}selected{% endif %}>CVO/DSP (APEPDCL) - Vizag</option>
                    <option value="cvo_apcpdcl_vijayawada" data-i18n="petition.form.office.apcpdcl" {% if request.form.get('received_at') == 'cvo_apcpdcl_vijayawada' %}selected{% endif %}>CVO/DSP (APCPDCL) - Vijayawada</option>
                    {% endif %}
                </select>
            </div>

            <div class="form-group">
                <label for="ereceipt_no"><span data-i18n="petition.form.ereceipt_no">{{ f_ereceipt_no.label }}</span> {% if f_ereceipt_no.required %}<span class="required">*</span>{% endif %}</label>
                <input type="{{ f_ereceipt_no.type }}" id="ereceipt_no" name="ereceipt_no" value="{{ request.form.get('ereceipt_no', '') }}" {% if f_ereceipt_no.required %}required{% endif %} placeholder="Enter e-receipt number" data-i18n-placeholder="petition.form.ph_ereceipt_no">
            </div>

            <div class="form-group">
                <label for="ereceipt_file"><span data-i18n="petition.form.ereceipt_file">{{ f_ereceipt_file.label }}</span> {% if f_ereceipt_file.required %}<span class="required">*</span>{% endif %}</label>
                <input type="file" id="ereceipt_file" name="ereceipt_file" accept=".pdf" {% if f_ereceipt_file.required %}required{% endif %} style="position:absolute;left:-9999px;" aria-hidden="true" tabindex="-1">
                <div class="file-picker">
                    <button type="button" class="btn btn-outline btn-sm" id="ereceipt_file_btn" data-i18n="petition.form.choose_file">Choose File</button>
                    <span id="ereceipt_file_name" data-i18n="petition.form.no_file">No file chosen</span>
                </div>
            </div>

            <div class="form-group" id="target_cvo_group">
                <label for="target_cvo"><span data-i18n="petition.form.target_cvo">{{ f_target_cvo.label }}</span> {% if f_target_cvo.required %}<span class="required">*</span>{% endif %}</label>
                <select id="target_cvo" name="target_cvo" {% if f_target_cvo.required %}required{% endif %}>
                    <option value="" data-i18n="petition.form.select_cvo">-- Select CVO/DSP --</option>
                    {% if deo_locked and deo_flow.received_at != 'jmd_office' %}
                    {% for opt in deo_target_options %}
                    {% if opt.received_at != 'jmd_office' %}
                    <option value="{{ opt.target_cvo }}" data-received-at="{{ opt.received_at }}" {% if (request.form.get('target_cvo') and request.form.get('target_cvo') == opt.target_cvo) or (not request.form.get('target_cvo') and loop.first) %}selected{% endif %}>{{ opt.target_cvo_label }}</option>
                    {% endif %}
                    {% endfor %}
                    {% else %}
                    <option value="apspdcl" data-i18n="petition.form.target.apspdcl" {% if request.form.get('target_cvo') == 'apspdcl' %}selected{% endif %}>APSPDCL (Tirupathi)</option>
                    <option value="apepdcl" data-i18n="petition.form.target.apepdcl" {% if request.form.get('target_cvo') == 'apepdcl' %}selected{% endif %}>APEPDCL (Vizag)</option>
                    <option value="apcpdcl" data-i18n="petition.form.target.apcpdcl" {% if request.form.get('target_cvo') == 'apcpdcl' %}selected{% endif %}>APCPDCL (Vijayawada)</option>
                    <option value="headquarters" data-i18n="petition.form.target.headquarters" {% if request.form.get('target_cvo') == 'headquarters' %}selected{% endif %}>Headquarters (DSP)</option>
                    {% endif %}
                </select>
            </div>

            <div class="form-group" id="permission_request_group">
                <label for="permission_request_type"><span data-i18n="petition.form.permission_request">{{ f_permission_request.label }}</span> {% if f_permission_request.required %}<span class="required">*</span>{% endif %}</label>
                {% if deo_locked %}
                <input type="hidden" id="permission_request_type" name="permission_request_type" value="{{ 'permission_required' if deo_flow and deo_flow.force_permission_required else 'direct_enquiry' }}">
                <input type="text" value="Decided at CVO/DSP stage" readonly>
                {% else %}
                <select id="permission_request_type" name="permission_request_type" {% if f_permission_request.required %}required{% endif %}>
                    {% if deo_locked and deo_flow.force_permission_required %}
                    <option value="permission_required" selected data-i18n="petition.form.permission.permission_required">Permission Based (CVO/DSP sends to PO for approval)</option>
                    {% else %}
                    <option value="direct_enquiry" data-i18n="petition.form.permission.direct_enquiry" {% if (request.form.get('permission_request_type') or 'direct_enquiry') == 'direct_enquiry' %}selected{% endif %}>Direct</option>
                    <option value="permission_required" data-i18n="petition.form.permission.permission_required" {% if request.form.get('permission_request_type') == 'permission_required' %}selected{% endif %}>Permission Based (CVO/DSP sends to PO for approval)</option>
                    {% endif %}
                </select>
                {% endif %}
            </div>
            
            <div class="form-group full-width">
                <label for="petitioner_name"><span data-i18n="petition.form.petitioner_name">{{ f_petitioner_name.label }}</span> {% if f_petitioner_name.required %}<span class="required">*</span>{% endif %}</label>
                {% if f_petitioner_name.type == 'textarea' %}
                <textarea id="petitioner_name" name="petitioner_name" rows="2" {% if f_petitioner_name.required %}required{% endif %} placeholder="Leave blank if anonymous" data-i18n-placeholder="petition.form.ph_petitioner_name">{{ request.form.get('petitioner_name', '') }}</textarea>
                {% else %}
                <input type="{{ f_petitioner_name.type }}" id="petitioner_name" name="petitioner_name" value="{{ request.form.get('petitioner_name', '') }}" {% if f_petitioner_name.required %}required{% endif %} placeholder="Leave blank if anonymous" data-i18n-placeholder="petition.form.ph_petitioner_name">
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="contact"><span data-i18n="petition.form.contact">{{ f_contact.label }}</span> {% if f_contact.required %}<span class="required">*</span>{% endif %}</label>
                {% if f_contact.type == 'textarea' %}
                <textarea id="contact" name="contact" rows="2" {% if f_contact.required %}required{% endif %} placeholder="Phone number" data-i18n-placeholder="petition.form.ph_contact">{{ request.form.get('contact', '') }}</textarea>
                {% else %}
                <input type="{{ f_contact.type }}" id="contact" name="contact" value="{{ request.form.get('contact', '') }}" pattern="[0-9+\-\s()]{7,20}" {% if f_contact.required %}required{% endif %} placeholder="Phone number" data-i18n-placeholder="petition.form.ph_contact">
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="place"><span data-i18n="petition.form.place">{{ f_place.label }}</span> {% if f_place.required %}<span class="required">*</span>{% endif %}</label>
                {% if f_place.type == 'textarea' %}
                <textarea id="place" name="place" rows="2" {% if f_place.required %}required{% endif %} placeholder="Location / Area" data-i18n-placeholder="petition.form.ph_place">{{ request.form.get('place', '') }}</textarea>
                {% else %}
                <input type="{{ f_place.type }}" id="place" name="place" value="{{ request.form.get('place', '') }}" {% if f_place.required %}required{% endif %} placeholder="Location / Area" data-i18n-placeholder="petition.form.ph_place">
                {% endif %}
            </div>
            
            <div class="form-group full-width">
                <label for="subject"><span data-i18n="petition.form.subject">{{ f_subject.label }}</span> {% if f_subject.required %}<span class="required">*</span>{% endif %}</label>
                {% if f_subject.type == 'textarea' %}
                <textarea id="subject" name="subject" rows="3" {% if f_subject.required %}required{% endif %} placeholder="Brief description of the petition subject" data-i18n-placeholder="petition.form.ph_subject">{{ request.form.get('subject', '') }}</textarea>
                {% else %}
                <input type="{{ f_subject.type }}" id="subject" name="subject" value="{{ request.form.get('subject', '') }}" {% if f_subject.required %}required{% endif %} placeholder="Brief description of the petition subject" data-i18n-placeholder="petition.form.ph_subject">
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="petition_type"><span data-i18n="petition.form.petition_type">{{ f_petition_type.label }}</span> {% if f_petition_type.required %}<span class="required">*</span>{% endif %}</label>
                <select id="petition_type" name="petition_type" {% if f_petition_type.required %}required{% endif %}>
                    <option value="" data-i18n="petition.form.select_type">-- Select Type --</option>
                    <option value="bribe" data-i18n="petition.form.type.bribe" {% if request.form.get('petition_type') == 'bribe' %}selected{% endif %}>Bribe</option>
                    <option value="corruption" {% if request.form.get('petition_type') == 'corruption' %}selected{% endif %}>Corruption</option>
                    <option value="harassment" data-i18n="petition.form.type.harassment" {% if request.form.get('petition_type') == 'harassment' %}selected{% endif %}>Harassment</option>
                    <option value="electrical_accident" {% if request.form.get('petition_type') == 'electrical_accident' %}selected{% endif %}>Electrical Accident</option>
                    <option value="misconduct" {% if request.form.get('petition_type') == 'misconduct' %}selected{% endif %}>Misconduct</option>
                    <option value="works_related" {% if request.form.get('petition_type') == 'works_related' %}selected{% endif %}>Works Related</option>
                    <option value="irregularities_in_tenders" {% if request.form.get('petition_type') == 'irregularities_in_tenders' %}selected{% endif %}>Irregularities in Tenders</option>
                    <option value="illegal_assets" {% if request.form.get('petition_type') == 'illegal_assets' %}selected{% endif %}>Illegal Assets</option>
                    <option value="fake_certificates" {% if request.form.get('petition_type') == 'fake_certificates' %}selected{% endif %}>Fake Certificates</option>
                    <option value="theft_misappropriation_materials" {% if request.form.get('petition_type') == 'theft_misappropriation_materials' %}selected{% endif %}>Theft/Misappropriation of Materials</option>
                    <option value="other" data-i18n="petition.form.type.other" {% if request.form.get('petition_type') == 'other' %}selected{% endif %}>Other</option>
                </select>
            </div>

            <div class="form-group">
                <label for="source_of_petition"><span data-i18n="petition.form.source_of_petition">{{ f_source.label }}</span> {% if f_source.required %}<span class="required">*</span>{% endif %}</label>
                <select id="source_of_petition" name="source_of_petition" {% if f_source.required %}required{% endif %}>
                    <option value="media" data-i18n="petition.form.source.media" {% if request.form.get('source_of_petition') == 'media' %}selected{% endif %}>Media</option>
                    <option value="public_individual" data-i18n="petition.form.source.public_individual" {% if (request.form.get('source_of_petition') or 'public_individual') == 'public_individual' %}selected{% endif %}>Public (Individual)</option>
                    <option value="govt" data-i18n="petition.form.source.govt" {% if request.form.get('source_of_petition') == 'govt' %}selected{% endif %}>Govt</option>
                    <option value="sumoto" data-i18n="petition.form.source.sumoto" {% if request.form.get('source_of_petition') == 'sumoto' %}selected{% endif %}>Sumoto</option>
                    {% if show_cmd_source_option %}
                    <option value="cmd_office" {% if request.form.get('source_of_petition') == 'cmd_office' %}selected{% endif %}>O/o CMD</option>
                    {% endif %}
                </select>
            </div>
            <div class="form-group" id="govt_institution_group" style="display:none;">
                <label for="govt_institution_type"><span data-i18n="petition.form.govt_institution_type">{{ f_govt_inst.label }}</span> {% if f_govt_inst.required %}<span class="required">*</span>{% endif %}</label>
                <select id="govt_institution_type" name="govt_institution_type" {% if f_govt_inst.required %}required{% endif %}>
                    <option value="" data-i18n="petition.form.select_institution">-- Select Institution --</option>
                    {% for opt in f_govt_inst.options %}
                    <option value="{{ opt.value }}" {% if request.form.get('govt_institution_type') == opt.value %}selected{% endif %}>{{ opt.label }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label data-i18n="petition.form.workflow_note">Workflow Note</label>
                <input type="text" value="Detailed SLA: 45 days | Preliminary SLA: 7 days" data-i18n-value="petition.form.workflow_note_value" readonly>
            </div>
            
            <div class="form-group full-width">
                <label for="remarks"><span data-i18n="petition.form.remarks">{{ f_remarks.label }}</span> {% if f_remarks.required %}<span class="required">*</span>{% endif %}</label>
                {% if f_remarks.type == 'textarea' %}
                <textarea id="remarks" name="remarks" rows="2" {% if f_remarks.required %}required{% endif %} placeholder="Any additional remarks" data-i18n-placeholder="petition.form.ph_remarks">{{ request.form.get('remarks', '') }}</textarea>
                {% else %}
                <input type="{{ f_remarks.type }}" id="remarks" name="remarks" value="{{ request.form.get('remarks', '') }}" {% if f_remarks.required %}required{% endif %} placeholder="Any additional remarks" data-i18n-placeholder="petition.form.ph_remarks">
                {% endif %}
            </div>
        </div>
        
        <div class="form-actions">
            <a href="{{ url_for('petitions_list') }}" class="btn btn-outline" data-i18n="petition.form.cancel">Cancel</a>
            <button type="submit" class="btn btn-primary">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                <span data-i18n="petition.form.save">Save Petition</span>
            </button>
        </div>
    </form>
</div>
<script>
(() => {
    const receivedAt = document.getElementById('received_at');
    const targetGroup = document.getElementById('target_cvo_group');
    const targetCvo = document.getElementById('target_cvo');
    const permissionGroup = document.getElementById('permission_request_group');
    const permissionType = document.getElementById('permission_request_type');
    const sourcePetition = document.getElementById('source_of_petition');
    const govtInstitutionGroup = document.getElementById('govt_institution_group');
    const govtInstitutionType = document.getElementById('govt_institution_type');
    const ereceiptFileInput = document.getElementById('ereceipt_file');
    const ereceiptFileBtn = document.getElementById('ereceipt_file_btn');
    const ereceiptFileName = document.getElementById('ereceipt_file_name');
    if (!receivedAt || !targetGroup || !targetCvo || !permissionGroup || !permissionType || !sourcePetition || !govtInstitutionGroup || !govtInstitutionType) return;

    const syncWorkflowFields = () => {
        const isJmdOffice = receivedAt.value === 'jmd_office';
        targetGroup.style.display = isJmdOffice ? 'none' : '';
        permissionGroup.style.display = isJmdOffice ? 'none' : '';
        if (isJmdOffice) {
            targetCvo.value = '';
            permissionType.value = 'permission_required';
        }
    };

    const syncReceivedFromTarget = () => {
        const selectedOption = targetCvo.options[targetCvo.selectedIndex];
        if (!selectedOption) return;
        const mappedReceivedAt = selectedOption.dataset.receivedAt;
        if (!mappedReceivedAt) return;
        receivedAt.value = mappedReceivedAt;
    };

    targetCvo.addEventListener('change', () => {
        syncReceivedFromTarget();
        syncWorkflowFields();
    });
    syncReceivedFromTarget();
    receivedAt.addEventListener('change', syncWorkflowFields);
    syncWorkflowFields();

    const syncGovtInstitutionField = () => {
        const isGovt = sourcePetition.value === 'govt';
        govtInstitutionGroup.style.display = isGovt ? '' : 'none';
        govtInstitutionType.required = isGovt && {{ 1 if f_govt_inst.required else 0 }};
        if (!isGovt) govtInstitutionType.value = '';
    };

    sourcePetition.addEventListener('change', syncGovtInstitutionField);
    syncGovtInstitutionField();

    if (ereceiptFileInput && ereceiptFileBtn && ereceiptFileName) {
        ereceiptFileBtn.addEventListener('click', () => ereceiptFileInput.click());
        ereceiptFileInput.addEventListener('change', () => {
            if (ereceiptFileInput.files && ereceiptFileInput.files.length > 0) {
                ereceiptFileName.textContent = ereceiptFileInput.files[0].name;
            } else {
                const fallback = ereceiptFileName.getAttribute('data-i18n');
                if (fallback === 'petition.form.no_file') {
                    ereceiptFileName.textContent = 'No file chosen';
                }
            }
        });
    }
})();
</script>
{% endblock %}


