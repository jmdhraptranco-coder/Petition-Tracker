{% extends "base.html" %}
{% block title %}Form Management - Petition Tracker{% endblock %}
{% block page_title %}Form Management{% endblock %}

{% block content %}
<div class="card form-mgmt-hero">
    <div class="card-header">
        <h2>Form Management</h2>
    </div>
    <div class="form-mgmt-hero-body">
        <p>Configure field labels, field types, required rules, and dropdown options for DEO/Inspector/CVO/CMD/PO forms.</p>
        <div class="form-mgmt-guide">
            <span><strong>Dropdown Options Format:</strong> <code>value|Label</code> (one per line)</span>
            <span><strong>Example:</strong> <code>aprc|1. APRC</code></span>
        </div>
    </div>
 </div>

<div class="card form-mgmt-hero">
    <div class="card-header">
        <h3>Field Editor Selection</h3>
    </div>
    <div class="form-mgmt-hero-body">
        <div class="form-grid">
            <div class="form-group">
                <label>Form Group / Login Flow</label>
                <select id="fmFormSelect" class="filter-select" onchange="applyFormFieldSelection()">
                    <option value="">-- Select Form Group --</option>
                    {% for fk, title in form_groups.items() %}
                    <option value="{{ fk }}">{{ title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Field to Update</label>
                <select id="fmFieldSelect" class="filter-select" onchange="applyFormFieldSelection()">
                    <option value="">-- Select Field --</option>
                </select>
            </div>
        </div>
        <small id="fmFieldPrompt" class="form-help">Select form group and field. Only one field editor is shown at a time.</small>
    </div>
</div>

<div class="card form-mgmt-section">
    <div class="card-header">
        <h3>Add New Field</h3>
    </div>
    <form method="POST" action="{{ url_for('form_management') }}" class="form-mgmt-field-card form-mgmt-add-card">
        <input type="hidden" name="action" value="add_field">
        <div class="form-mgmt-add-grid">
            <div class="form-group form-mgmt-add-form">
                <label>Required for Login / Workflow <span class="required">*</span></label>
                <select name="new_form_key" required>
                    <option value="">-- Select Form Group --</option>
                    {% for fk, title in form_groups.items() %}
                    <option value="{{ fk }}">{{ title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group form-mgmt-add-key">
                <label>Field Key <span class="required">*</span></label>
                <input type="text" name="new_field_key" required placeholder="example: vigilance_note">
            </div>
            <div class="form-group form-mgmt-add-label">
                <label>Label <span class="required">*</span></label>
                <input type="text" name="new_label" required placeholder="Field label">
            </div>
            <div class="form-group form-mgmt-add-type">
                <label>Field Type</label>
                <select name="new_field_type">
                    {% for t in field_types %}
                    <option value="{{ t }}">{{ t|upper }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group form-mgmt-add-required">
                <label class="form-mgmt-required-toggle">
                    <input type="checkbox" name="new_is_required">
                    Required Field
                </label>
            </div>
            <div class="form-mgmt-add-actions">
                <button type="submit" class="btn btn-primary btn-sm">Add Field</button>
            </div>
        </div>
        <small class="form-mgmt-add-hint">Field key format: lowercase letters, numbers, and underscore only (example: <code>vigilance_note</code>).</small>
    </form>
</div>

{% if not grouped_fields %}
<div class="card">
    <div class="empty-state">No form fields configured.</div>
</div>
{% endif %}

{% for form_key, rows in grouped_fields.items() %}
<div class="card form-mgmt-section" data-fm-section="{{ form_key }}">
    <div class="card-header">
        <h3>{{ form_groups.get(form_key, form_key) }}</h3>
        <span class="form-mgmt-count">{{ rows|length }} fields</span>
    </div>
    <div class="form-mgmt-grid">
        {% for r in rows %}
        <form method="POST" action="{{ url_for('form_management') }}" class="form-mgmt-field-card js-fm-card" data-fm-form="{{ r.form_key }}" data-fm-field="{{ r.field_key }}">
            <input type="hidden" name="action" value="update_field">
            <input type="hidden" name="form_key" value="{{ r.form_key }}">
            <input type="hidden" name="field_key" value="{{ r.field_key }}">

            <div class="form-mgmt-field-head">
                <code class="form-mgmt-field-key">{{ r.field_key }}</code>
                <label class="form-mgmt-required-toggle">
                    <input type="checkbox" name="is_required" {% if r.required %}checked{% endif %}>
                    Required
                </label>
            </div>

            <div class="form-mgmt-field-body">
                <div class="form-group">
                    <label>Label</label>
                    <input type="text" name="label" value="{{ r.label }}" required>
                </div>
                <div class="form-group">
                    <label>Field Type</label>
                    <select name="field_type" class="fm-field-type">
                        {% for t in field_types %}
                        <option value="{{ t }}" {% if r.type == t %}selected{% endif %}>{{ t|upper }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group full-width fm-options-wrap">
                    <label>Dropdown Options</label>
                    <div class="fm-options-builder">
                        <div class="fm-options-head">
                            <span>Value</span>
                            <span>Display Label</span>
                            <span></span>
                        </div>
                        <div class="fm-options-rows">
                            {% for o in r.options %}
                            <div class="fm-option-row">
                                <input type="text" class="fm-opt-value" value="{{ o.value }}" placeholder="value">
                                <input type="text" class="fm-opt-label" value="{{ o.label }}" placeholder="Display label">
                                <button type="button" class="btn btn-xs btn-outline fm-opt-remove">Remove</button>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="fm-options-actions">
                            <button type="button" class="btn btn-xs btn-outline fm-opt-add">Add Option</button>
                        </div>
                    </div>
                    <textarea name="options_text" rows="2" class="fm-options-hidden" aria-hidden="true"></textarea>
                    <small>Used only when field type is <code>select</code>.</small>
                </div>
            </div>

            <div class="form-mgmt-actions">
                <button type="submit" class="btn btn-primary btn-sm">Save Field</button>
            </div>
        </form>
        {% endfor %}
    </div>
</div>
{% endfor %}

<script>
(() => {
    const formSelect = document.getElementById('fmFormSelect');
    const fieldSelect = document.getElementById('fmFieldSelect');
    const prompt = document.getElementById('fmFieldPrompt');
    const cards = [...document.querySelectorAll('.js-fm-card')];
    const sections = [...document.querySelectorAll('.form-mgmt-section[data-fm-section]')];

    window.applyFormFieldSelection = function applyFormFieldSelection() {
        const selectedForm = formSelect?.value || '';
        const selectedField = fieldSelect?.value || '';

        if (fieldSelect) {
            const existingValue = fieldSelect.value;
            fieldSelect.innerHTML = '<option value="">-- Select Field --</option>';
            const seen = new Set();
            cards
                .filter((card) => card.dataset.fmForm === selectedForm)
                .forEach((card) => {
                    const field = card.dataset.fmField || '';
                    if (!field || seen.has(field)) return;
                    seen.add(field);
                    const option = document.createElement('option');
                    option.value = field;
                    option.textContent = field;
                    fieldSelect.appendChild(option);
                });
            if (existingValue && [...fieldSelect.options].some((opt) => opt.value === existingValue)) {
                fieldSelect.value = existingValue;
            }
        }

        cards.forEach((card) => {
            const formOk = selectedForm && card.dataset.fmForm === selectedForm;
            const fieldOk = selectedField && card.dataset.fmField === selectedField;
            card.style.display = formOk && fieldOk ? '' : 'none';
        });
        sections.forEach((section) => {
            section.style.display = selectedForm && section.dataset.fmSection === selectedForm ? '' : 'none';
        });

        if (prompt) {
            prompt.style.display = (selectedForm && selectedField) ? 'none' : '';
        }
    };

    formSelect?.addEventListener('change', () => {
        if (fieldSelect) fieldSelect.value = '';
        window.applyFormFieldSelection();
    });
    fieldSelect?.addEventListener('change', window.applyFormFieldSelection);
    window.applyFormFieldSelection();

    document.querySelectorAll('.form-mgmt-field-card').forEach((card) => {
        const typeSelect = card.querySelector('.fm-field-type');
        const optionsWrap = card.querySelector('.fm-options-wrap');
        const optionsRows = card.querySelector('.fm-options-rows');
        const addBtn = card.querySelector('.fm-opt-add');
        const hiddenOptions = card.querySelector('.fm-options-hidden');
        const form = card;
        if (!typeSelect || !optionsWrap) return;

        const buildHiddenOptions = () => {
            if (!hiddenOptions || !optionsRows) return;
            const lines = [];
            optionsRows.querySelectorAll('.fm-option-row').forEach((row) => {
                const value = (row.querySelector('.fm-opt-value')?.value || '').trim();
                const label = (row.querySelector('.fm-opt-label')?.value || '').trim();
                if (value && label) lines.push(`${value}|${label}`);
            });
            hiddenOptions.value = lines.join('\n');
        };

        const bindRemoveButtons = () => {
            optionsRows?.querySelectorAll('.fm-opt-remove').forEach((btn) => {
                btn.onclick = () => {
                    btn.closest('.fm-option-row')?.remove();
                    buildHiddenOptions();
                };
            });
        };

        const addOptionRow = (value = '', label = '') => {
            if (!optionsRows) return;
            const row = document.createElement('div');
            row.className = 'fm-option-row';
            row.innerHTML = `
                <input type="text" class="fm-opt-value" placeholder="value">
                <input type="text" class="fm-opt-label" placeholder="Display label">
                <button type="button" class="btn btn-xs btn-outline fm-opt-remove">Remove</button>
            `;
            row.querySelector('.fm-opt-value').value = value;
            row.querySelector('.fm-opt-label').value = label;
            optionsRows.appendChild(row);
            bindRemoveButtons();
            buildHiddenOptions();
        };

        if (addBtn) {
            addBtn.addEventListener('click', () => addOptionRow());
        }

        optionsRows?.querySelectorAll('input').forEach((input) => {
            input.addEventListener('input', buildHiddenOptions);
        });

        form?.addEventListener('submit', buildHiddenOptions);
        bindRemoveButtons();
        buildHiddenOptions();

        const toggle = () => {
            const isSelect = typeSelect.value === 'select';
            optionsWrap.style.display = isSelect ? '' : 'none';
            if (!isSelect && hiddenOptions) hiddenOptions.value = '';
        };
        typeSelect.addEventListener('change', toggle);
        toggle();
    });
})();
</script>
{% endblock %}

